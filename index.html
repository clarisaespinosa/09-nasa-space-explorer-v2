<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA Space Explorer - APOD Gallery</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles for the dark space theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .apod-card {
            /* Smooth transitions */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            background-color: #161b22; 
            border: 1px solid #30363d;
        }

        .apod-card:hover {
            /* Purple glow effect */
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 15px 25px rgba(139, 92, 246, 0.6); 
        }

        .modal-bg {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
        }

        .modal-content-container {
            max-height: 90vh;
        }

        /* Responsive Media container (16:9) */
        .media-responsive {
            position: relative;
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background-color: #000;
        }

        .media-responsive iframe,
        .media-responsive img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* "Did You Know?" box style */
        #did-you-know {
            background-color: #1c212a;
            border-left: 5px solid #8b5cf6;
            color: #e2e8f0;
            padding: 1rem;
            margin-bottom: 2rem;
            border-radius: 0.5rem;
            font-style: italic;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #did-you-know strong {
            color: #a78bfa;
            font-weight: 600;
        }

        /* Date input style */
        input[type="date"] {
            background-color: #2d3748;
            color: #edf2f7;
            border: 1px solid #4a5568;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            appearance: none;
            cursor: pointer;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-8 flex-grow">
        <header class="text-center mb-12">
            <div class="flex flex-col sm:flex-row items-center justify-center mb-6">
                <img src="img/NASA-Logo-Large.jpg" alt="NASA Logo" class="h-16 sm:h-20 mr-0 sm:mr-4 mb-4 sm:mb-0 rounded-lg">
                <h1 class="text-5xl sm:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">
                    Space Explorer
                </h1>
                <img src="img/nasa-worm-logo.png" alt="NASA Worm Logo" class="h-12 sm:h-16 ml-0 sm:ml-4 mt-4 sm:mt-0">
            </div>
            <p class="text-xl text-gray-400">Astronomy Picture of the Day (APOD) Gallery</p>
        </header>

        <div id="did-you-know" class="max-w-3xl mx-auto mb-8 hidden">
            <p><strong>Did You Know?</strong> <span id="fact-text"></span></p>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <label for="start-date" class="text-lg text-gray-300">Display 9 days, ending on the selected date:</label>
            <input type="date" id="start-date" class="text-lg">
            <button id="fetch-button" disabled class="bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out">
                Load Gallery
            </button>
        </div>

        <div id="loading-indicator" class="text-center p-10 hidden">
            <svg class="animate-spin h-10 w-10 mx-auto text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg">Loading Astronomical Data...</p>
        </div>

        <div id="gallery-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            </div>

        <div id="error-message" class="hidden text-center p-10 text-red-400">
            <p id="error-text" class="text-2xl"></p>
        </div>
    </div>

    <div id="details-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-4">
        
        <div class="modal-content-container bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl overflow-y-auto">
            <div class="p-6">
                
                <div class="flex justify-end">
                    <button id="close-modal-button" class="text-gray-400 hover:text-white transition duration-200 text-3xl font-bold">&times;</button>
                </div>

                <div id="modal-media" class="media-responsive rounded-lg mb-6 border border-purple-600">
                    </div>

                <h2 id="modal-title" class="text-3xl font-extrabold text-purple-300 mb-3"></h2>
                <p id="modal-date" class="text-sm text-gray-400 mb-4"></p>
                <div id="modal-explanation" class="text-gray-200 leading-relaxed text-base border-t border-gray-700 pt-4"></div>
            </div>
        </div>
    </div>

    <footer class="text-center p-8 mt-12 border-t border-gray-700">
        <p class="text-gray-500 text-sm">
            Please note: This gallery runs on a static JSON feed provided for this project. 
            Data is limited and may not contain entries for all 9 days, especially after October 1, 2025.
        </p>
    </footer>


    <script>
        // --- FUNCIÓN DE ARRANQUE SEGURA ---
        // Espera a que la página esté completamente cargada
        window.onload = function() {
            
            // --- CONSTANTES Y GLOBALES (Definidas DESPUÉS de que el DOM esté listo) ---
            const DATA_URL = 'https://cdn.jsdelivr.net/gh/GCA-Classroom/apod/data.json'; 

            const galleryContainer = document.getElementById('gallery-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            const startDateInput = document.getElementById('start-date');
            const fetchButton = document.getElementById('fetch-button'); 

            const detailsModal = document.getElementById('details-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalDate = document.getElementById('modal-date');
            const modalMedia = document.getElementById('modal-media');
            const modalExplanation = document.getElementById('modal-explanation');
            const closeModalButton = document.getElementById('close-modal-button');
            const modalContentContainer = document.querySelector('.modal-content-container');

            const factTextElement = document.getElementById('fact-text');
            const didYouKnowSection = document.getElementById('did-you-know');

            let fullApodData = [];
            let isDataLoaded = false; 

            const DID_YOU_KNOW_FACTS = [
                "The universe is vast and contains billions of galaxies, each with billions of stars.",
                "Sunlight takes approximately 8 minutes and 20 seconds to reach Earth.",
                "Jupiter is the largest planet in our solar system and hosts a giant storm that has lasted for centuries.",
                "The Milky Way, our galaxy, is a barred spiral galaxy and has a supermassive black hole at its center.",
                "There are more stars in the universe than grains of sand on all the beaches on Earth."
            ];

            // --- UTILITY FUNCTIONS ---
            function formatDate(dateString) {
                if (!dateString) return 'Unknown Date';
                try {
                    const [year, month, day] = dateString.split('-');
                    return `${month}/${day}/${year}`; 
                } catch (e) {
                    return dateString; 
                }
            }

            // --- CORE DATA FETCHING ---
            async function fetchInitialData() {
                didYouKnowSection.classList.add('hidden'); 
                loadingIndicator.classList.remove('hidden');
                errorMessage.classList.add('hidden');
                galleryContainer.innerHTML = ''; 

                const randomFact = DID_YOU_KNOW_FACTS[Math.floor(Math.random() * DID_YOU_KNOW_FACTS.length)];
                factTextElement.textContent = randomFact;
                didYouKnowSection.classList.remove('hidden');

                try {
                    const response = await fetch(DATA_URL); 
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    fullApodData = await response.json();
                    
                    fullApodData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const maxDate = fullApodData[0]?.date || new Date().toISOString().split('T')[0];
                    startDateInput.setAttribute('max', maxDate);
                    startDateInput.value = maxDate; 

                    // Habilitar el botón AHORA que los datos están listos
                    isDataLoaded = true;
                    fetchButton.disabled = false;
                    fetchButton.classList.remove('bg-gray-600');
                    fetchButton.classList.add('bg-purple-600', 'hover:bg-purple-700', 'transform', 'hover:scale-105');

                    // Load the initial 9 items
                    filterAndRenderGallery(maxDate); 

                } catch (error) {
                    console.error("Error fetching initial JSON data:", error);
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    errorText.classList.add('text-red-400');
                    errorText.textContent = 'An error occurred while loading the JSON file. Please check the data source URL.';
                }
            }

            // --- GALLERY RENDERING AND FILTERING (Called by the button) ---
            function filterAndRenderGallery(selectedDate) {
                
                loadingIndicator.classList.remove('hidden');
                galleryContainer.innerHTML = '';
                errorMessage.classList.add('hidden');
                errorText.classList.remove('text-red-400', 'text-yellow-400');

                // 1. Filter elements up to and including the selected date
                const filteredData = fullApodData.filter(item => {
                    return item.date <= selectedDate; 
                });

                // 2. Sort newest first
                filteredData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // 3. Take the 9 most recent entries
                const finalData = filteredData.slice(0, 9);
                const itemsFound = finalData.length;

                if (itemsFound === 0) {
                    loadingIndicator.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                    errorText.classList.add('text-red-400');
                    errorText.textContent = 'ERROR: No APOD entries were found for the selected date. Try an earlier date.';
                    return;
                }
                
                // --- NEW WARNING LOGIC ---
                if (itemsFound < 9) {
                    errorMessage.classList.remove('hidden');
                    errorText.classList.add('text-yellow-400'); // Warning color
                    errorText.textContent = `WARNING: Only found ${itemsFound} items. The JSON feed is limited and may not contain data for all 9 days.`;
                }

                const cardsHtml = finalData.map(item => createCard(item)).join('');
                galleryContainer.innerHTML = cardsHtml;
                
                loadingIndicator.classList.add('hidden');
            }

            // --- CARD CREATION ---
            function createCard(item) {
                let mediaUrl = '';
                let mediaIcon = '';

                if (item.media_type === 'video' && item.thumbnail_url) {
                    mediaUrl = item.thumbnail_url;
                    mediaIcon = `<div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center">
                                    <svg class="w-16 h-16 text-white transition duration-300 hover:text-purple-400" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 16.5l6-4.5-6-4.5v9zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                                    </svg>
                                 </div>`;
                } else if (item.media_type === 'image') {
                    mediaUrl = item.url;
                } else {
                    mediaUrl = 'https://placehold.co/600x400/161b22/8b5cf6?text=MEDIA+NOT+AVAILABLE';
                    mediaIcon = `<div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center text-xl font-bold text-gray-400">No Content</div>`;
                }

                // *** LA CORRECCIÓN TÉCNICA (PARTE 1) ***
                // Ya no usamos 'onclick'
                // Guardamos los datos JSON directamente en el elemento usando un 'data-attribute'
                const itemJson = encodeURIComponent(JSON.stringify(item));

                return `
                    <div class="apod-card rounded-xl overflow-hidden shadow-lg" data-item-json="${itemJson}">
                        <div class="relative pt-[66.666%] bg-gray-700"> 
                            <img src="${mediaUrl}" 
                                 onerror="this.onerror=null;this.src='${item.url || 'https://placehold.co/600x400/161b22/8b5cf6?text=LOAD+ERROR'}';"
                                 alt="${item.title}" 
                                 loading="lazy"
                                 class="absolute top-0 left-0 w-full h-full object-cover transition duration-500 ease-in-out transform hover:scale-105">
                            ${mediaIcon}
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-purple-200 truncate">${item.title}</h3>
                            <p class="text-sm text-gray-400">${formatDate(item.date)}</p>
                        </div>
                    </div>
                `;
            }

            // --- MODAL FUNCTIONS (Ahora locales, no globales) ---
            function openModal(item) {
                modalTitle.textContent = item.title;
                modalDate.textContent = formatDate(item.date);
                modalExplanation.textContent = item.explanation; // <-- ESTA ES LA DESCRIPCIÓN
                modalMedia.innerHTML = ''; 

                let mediaElement;

                if (item.media_type === 'video' && item.url) {
                    if (item.url.includes('youtube.com/embed') || item.url.includes('player.vimeo')) {
                        mediaElement = document.createElement('iframe');
                        mediaElement.setAttribute('src', item.url);
                        mediaElement.setAttribute('frameborder', '0');
                        mediaElement.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
                        mediaElement.setAttribute('allowfullscreen', 'true');
                        mediaElement.setAttribute('title', item.title);
                        mediaElement.classList.add('w-full', 'h-full', 'rounded-lg');
                    } else {
                        // Muestra el link si no es un video incrustable
                        mediaElement = document.createElement('div');
                        mediaElement.classList.add('w-full', 'h-full', 'flex', 'flex-col', 'items-center', 'justify-center', 'text-center', 'text-2xl', 'text-gray-500', 'p-10');
                        mediaElement.innerHTML = `
                            <p class="mb-4">Video content cannot be embedded directly.</p>
                            <a href="${item.url}" target="_blank" class="text-purple-400 hover:text-purple-300 underline transition duration-300">Click here to View External Video</a>
                        `;
                    }
                } else if (item.media_type === 'image') {
                    const imageUrl = item.hdurl || item.url;
                    mediaElement = document.createElement('img');
                    mediaElement.setAttribute('src', imageUrl);
                    mediaElement.setAttribute('alt', item.title);
                    mediaElement.classList.add('w-full', 'h-full', 'object-contain', 'rounded-lg');
                    mediaElement.setAttribute('onerror', `this.onerror=null;this.src='${item.url || 'https://placehold.co/800x600/161b22/8b5cf6?text=Image+Error'}';`);
                } else {
                     mediaElement = document.createElement('div');
                     mediaElement.classList.add('w-full', 'h-full', 'flex', 'items-center', 'justify-center', 'text-2xl', 'text-gray-500', 'p-10');
                     mediaElement.textContent = 'Incompatible media type or URL not found.';
                }

                modalMedia.appendChild(mediaElement);
                detailsModal.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }

            function closeModal() {
                detailsModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                modalMedia.innerHTML = '';
            }

            // --- EVENT LISTENERS (La solución moderna y robusta) ---
            
            // 1. Botón de la Galería
            fetchButton.addEventListener('click', () => {
                if (!isDataLoaded) return; 

                const selectedDate = startDateInput.value;
                if (selectedDate) {
                    filterAndRenderGallery(selectedDate);
                } else {
                    errorMessage.classList.remove('hidden');
                    errorText.textContent = 'Please select a start date.';
                }
            });

            // 2. Clics en la Galería (para abrir el modal)
            galleryContainer.addEventListener('click', function(event) {
                // 'event.target' es lo que se clickeó (ej. la imagen)
                // '.closest()' encuentra el ancestro 'apod-card' más cercano
                const card = event.target.closest('.apod-card');
                
                if (!card) return; // Si el clic no fue en una tarjeta, no hacer nada

                // Obtener el JSON guardado en el 'data-attribute'
                const itemJson = card.dataset.itemJson;
                if (!itemJson) return;

                const item = JSON.parse(decodeURIComponent(itemJson));
                openModal(item); // Llamar a la función local
            });

            // 3. Clics para Cerrar el Modal
            closeModalButton.addEventListener('click', closeModal); // Botón X
            detailsModal.addEventListener('click', function(event) {
                // Si el clic es en el fondo oscuro (el modal mismo)
                if (event.target === detailsModal) {
                    closeModal();
                }
            });

            // --- INICIALIZACIÓN ---
            fetchInitialData();
        
        }; // Fin de window.onload
    </script>

</body>
</html>
